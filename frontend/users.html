<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Data User - J Store</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
  </head>
  <body class="bg-light p-4">
    <div class="container">
      <!-- Tombol Kembali ke Dashboard -->
      <a href="index.html" class="btn btn-secondary mb-3"
        >‚Üê Kembali ke Dashboard</a
      >

      <h2 class="mb-4">Manajemen User</h2>

      <form id="addUserForm" class="mb-4">
        <div class="row g-2">
          <div class="col">
            <input
              type="text"
              id="u_name"
              class="form-control"
              placeholder="Nama"
              required
            />
          </div>
          <div class="col">
            <input
              type="email"
              id="u_email"
              class="form-control"
              placeholder="Email"
              required
            />
          </div>
          <div class="col">
            <input
              type="password"
              id="u_password"
              class="form-control"
              placeholder="Password"
              required
            />
          </div>
          <div class="col">
            <button type="submit" class="btn btn-primary w-100">Tambah</button>
          </div>
        </div>
      </form>

      <table class="table table-bordered">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nama</th>
            <th>Email</th>
            <th>Password</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
    </div>

    <script>
      const api = "http://localhost:3000/users";

      // Fungsi untuk mendapatkan ID berikutnya (reuse ID kosong)
      async function getNextId() {
        const res = await fetch(api);
        const users = await res.json();
        const ids = users.map((u) => u.id);
        for (let i = 1; i <= ids.length + 1; i++) {
          if (!ids.includes(i)) return i;
        }
      }

      async function loadUsers() {
        const res = await fetch(api);
        let data = await res.json();

        // Urutkan data berdasarkan ID
        data.sort((a, b) => a.id - b.id);

        const tbody = document.getElementById("userTable");
        tbody.innerHTML = "";

        data.forEach((u) => {
          tbody.innerHTML += `
        <tr>
          <td>${u.id}</td>
          <td><input class='form-control' id='name_${u.id}' value='${u.name}'></td>
          <td><input class='form-control' id='email_${u.id}' value='${u.email}'></td>
          <td><input class='form-control' id='pass_${u.id}' value='${u.password}'></td>
          <td>
            <button class='btn btn-warning btn-sm' onclick='updateUser(${u.id})'>Update</button>
            <button class='btn btn-danger btn-sm' onclick='deleteUser(${u.id})'>Hapus</button>
          </td>
        </tr>
      `;
        });
      }

      function updateUser(id) {
        const data = {
          name: document.getElementById(`name_${id}`).value,
          email: document.getElementById(`email_${id}`).value,
          password: document.getElementById(`pass_${id}`).value,
        };

        fetch(`${api}/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        }).then(loadUsers);
      }

      function deleteUser(id) {
        fetch(`${api}/${id}`, { method: "DELETE" }).then(loadUsers);
      }

      document
        .getElementById("addUserForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const nextId = await getNextId(); // dapatkan ID kosong berikutnya
          const data = {
            id: nextId,
            name: document.getElementById("u_name").value,
            email: document.getElementById("u_email").value,
            password: document.getElementById("u_password").value,
          };

          fetch(api, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }).then(() => {
            e.target.reset();
            loadUsers();
          });
        });

      loadUsers();
    </script>
  </body>
</html>
